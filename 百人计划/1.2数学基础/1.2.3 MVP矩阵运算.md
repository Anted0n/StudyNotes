# MVP矩阵运算

---
## 目录
* MVP矩阵定义
  
---
## MVP矩阵定义
MVP矩阵分别是模型(**M**odel)，观察(**V**iew)，投影(**P**rojection)三个矩阵。

模型的顶点坐标来源于模型本身的网格，坐标系采用局部空间(Local Space)，通过M矩阵变换到世界坐标(World Space)，然后通过V矩阵变换到观察空间(View Space)，再通过P矩阵变换到裁剪空间(Clip Space)，最后裁剪空间经过一个投影映射，最终投射到屏幕空间(Screen Space)。

需要特别注意的是：模型顶点坐标的**局部空间→世界空间→观察空间→裁剪空间**变换过程，全部发生在几何阶段的顶点着色器阶段。
![顶点变换过程示意图](.\src\1.2.3-1.png)
### M矩阵
M矩阵的作用是将顶点坐标从局部空间(模型空间)变换到世界空间。

不同的软件中采用的坐标系标准是不同的。在3DMAX中采用右手坐标系，$X$轴代表物体左右，$Y$轴代表物体前后，$Z$轴代表物体上下；而在Unity当中采用左手坐标系，$X$轴代表物体左右，$Z$轴代表物体前后，$Y$轴代表物体上下。

坐标从模型空间变换到世界空间时，经历的步骤是：
1. 缩放
2. 旋转
3. 平移

这个顺序是引擎决定的，是不能够改变的。以此可以求出M矩阵：
$$
M=\begin{bmatrix}
    1&0&0&t_x\\
    0&1&0&t_y\\
    0&0&1&t_z\\
    0&0&0&1
\end{bmatrix}\begin{bmatrix}
    \cos\theta&0&\sin\theta&0\\
    0&1&0&0\\
    -\sin\theta&0&\cos\theta&0\\
    0&0&0&1\\
\end{bmatrix}\begin{bmatrix}
    k_x&0&0&0\\
    0&k_y&0&0\\
    0&0&k_z&0\\
    0&0&0&1\\
\end{bmatrix}
$$
### V矩阵
V矩阵的作用是将顶点从世界空间变换到视觉空间(观察空间)。

视觉空间是以摄像机为原点的空间坐标系，Unity当中依然采用左手系，以摄像机前方为$Z$轴。特别注意的是，Unity当中摄像机的$Z$轴正方向为$-Z$方向。

要求出V矩阵，首先需要理解，摄像机在Unity中同样是通过物体的方式进行移动的，它的坐标变换过程遵循模型空间到世界空间的变换。要求出物体在观察空间的坐标，需要将世界空间的坐标系平移，使其与摄像机的坐标系重合。由此可以推出，V矩阵是将摄像机平移到世界坐标原点这一变换矩阵的逆变换。

由此得出的步骤是：
1. 平移
2. 旋转
3. $Z$分量取反(因为$Z$轴正方向为负)

可以求出V矩阵：
$$
V=\begin{bmatrix}
    1&0&0&0\\
    0&\cos\theta&-\sin\theta&0\\
    0&\sin\theta&\cos\theta&0\\
    0&0&0&1\\
\end{bmatrix}\begin{bmatrix}
    1&0&0&t_x\\
    0&1&0&t_y\\
    0&0&1&t_z\\
    0&0&0&1\\
\end{bmatrix}
$$
### P矩阵
P矩阵的作用是将顶点从视觉空间变换到裁剪空间。

裁剪空间是一个比较抽象的坐标系，它相当于摄像机的视锥体范围，会根据投影类型的不同而变化。这一步变换也并不是真正的投影和裁剪过程，而是为后续的投影和裁剪做准备。

P矩阵计算的结果用于判断顶点是否位于裁剪空间之内，它会对顶点坐标的$x,y,z$分量进行缩放，并用$w$分量作为范围值。如果$x,y,z$都在$w$范围内，便可得知该顶点在裁剪空间内。

以透视投影的视锥体为例，对P矩阵进行推导，推导过程参考《Unity Shader入门精要》：

首先，视锥体的意义在于定义场景内的一块三维空间，如果顶点位于这个空间内，那么后续将会被投影并渲染，否则被裁剪。视锥体由一个近面和一个远面，这两个裁剪平面构成。首先观察视锥体的纵向截面，它能够通过Near(近面到原点距离)、Far(远面到原点距离)、FOV(Field of View)(视锥体张开角度)三个变量进行定义。
![视锥体侧面示意图](.\src\1.2.3-2.png)
令近面的高为nearClipPlaneHeight，远面高为farClipPlaneHeight，易知：
$$
nearClipPlaneHeight=2\cdot Near\cdot\tan \frac{FOV}{2}\\
farClipPlaneHeight=2\cdot Far\cdot\tan \frac{FOV}{2}\\
$$
而视锥体截面的长和宽是固定比值，定义量$Aspect$作为长宽比，使其满足：
$$
Aspect=\frac{nearClipPlaneWidth}{nearClipPlaneHeight}=\frac{farClipPlaneWidth}{farClipPlaneHeight}
$$
(具体推导过程给我整晕了，改天补上)